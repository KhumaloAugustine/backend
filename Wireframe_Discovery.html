<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mental Health Data Discovery – Test Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:  '#f1f5ff',
              100: '#e2ebff',
              200: '#c3d3ff',
              300: '#9db4ff',
              400: '#6c8afa',
              500: '#4463f0',
              600: '#354dd1',
              700: '#2739a7',
              800: '#1f2f84',
              900: '#182463'
            }
          }
        }
      }
    }
  </script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .break-long { word-break: break-word; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="border-b border-slate-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand-500 flex items-center justify-center text-white font-semibold text-lg">
          MH
        </div>
        <div>
          <div class="font-semibold text-slate-900 text-lg">Mental Health Data Discovery</div>
          <div class="text-xs text-slate-500">Datasets first. Studies as evidence.</div>
        </div>
      </div>

      <div class="hidden md:flex items-center gap-3 flex-1 max-w-xl">
        <div class="relative flex-1">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 105.25 5.25a7.5 7.5 0 0011.4 11.4z" />
            </svg>
          </span>
          <input
            id="global-search"
            type="text"
            placeholder="Search all dataset fields (name, source, constructs, studies, email, URL)…"
            class="w-full pl-9 pr-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-brand-400 focus:border-brand-400 text-sm"
          />
        </div>
      </div>

      <div class="flex items-center gap-4">
        <button
          class="hidden sm:inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
          <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
          Test data mode
        </button>
      </div>
    </div>
  </header>

  <!-- NAV -->
  <nav class="border-b border-slate-200 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between gap-4 py-2">
        <div class="flex gap-1 text-sm">
          <button class="tab-btn px-3 py-1.5 rounded-full font-medium text-slate-700 bg-slate-100"
                  data-target="tab-home">
            Home
          </button>
          <button class="tab-btn px-3 py-1.5 rounded-full font-medium text-slate-500 hover:bg-slate-100"
                  data-target="tab-datasets">
            Datasets
          </button>
          <button class="tab-btn px-3 py-1.5 rounded-full font-medium text-slate-500 hover:bg-slate-100"
                  data-target="tab-constructs">
            Constructs
          </button>
        </div>
        <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
          <span class="px-2 py-1 rounded-full border border-slate-200">
            View as: <span class="font-semibold text-slate-800">Dataset-centric</span>
          </span>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

      <!-- HOME TAB -->
      <section id="tab-home" class="tab-content active">
        <div class="grid gap-6 lg:grid-cols-2 items-center mb-10">
          <div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-semibold text-slate-900 mb-3">
              Discover mental health datasets,
              <span class="text-brand-600">with evidence from studies.</span>
            </h1>
            <p class="text-sm sm:text-base text-slate-600 mb-5">
              This prototype uses your test data file. Click a dataset to see its constructs,
              instruments, and the studies that have used it in a focused popup. Open-access
              datasets link out to the portal; formal requests open a pre-filled email.
            </p>

            <div class="flex flex-wrap gap-3 mb-4">
              <button
                class="tab-btn inline-flex items-center gap-2 px-4 py-2 rounded-full bg-brand-600 text-white text-sm font-medium shadow-sm hover:bg-brand-700"
                data-target="tab-datasets">
                <span>Explore Datasets</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M17 8l4 4m0 0l-4 4m4-4H7" />
                </svg>
              </button>
              <button
                class="tab-btn inline-flex items-center gap-2 px-4 py-2 rounded-full border border-slate-300 text-slate-700 text-sm font-medium hover:bg-slate-100"
                data-target="tab-constructs">
                Explore Constructs
              </button>
            </div>

            <div class="flex flex-wrap gap-2 text-xs text-slate-500">
              <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-100">
                <span class="w-1.5 h-1.5 rounded-full bg-brand-500"></span>
                Depression · Emotional & Behavioural · PTSD
              </span>
              <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-100">
                NIDS · Agincourt · SHaW · Hiscox · CPMH
              </span>
            </div>
          </div>

          <!-- Conceptual model -->
          <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 sm:p-5">
            <div class="text-xs font-semibold text-slate-500 mb-2">
              Conceptual model
            </div>
            <div class="relative">
              <div class="flex justify-center mb-6">
                <div class="px-4 py-2 rounded-full bg-brand-50 border border-brand-200 text-xs font-semibold text-brand-800">
                  Mental Health Constructs
                </div>
              </div>
              <div class="flex justify-center mb-6">
                <div class="px-4 py-2 rounded-full bg-slate-900 text-xs font-semibold text-white shadow">
                  Datasets (test data)
                </div>
              </div>
              <div class="flex justify-center">
                <div class="px-4 py-2 rounded-full bg-slate-100 border border-slate-300 text-xs font-semibold text-slate-800">
                  Studies (evidence &amp; context, under each dataset)
                </div>
              </div>

              <div class="absolute inset-x-0 top-10 flex justify-center">
                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m0 0l-4-4m4 4l4-4"/>
                </svg>
              </div>
              <div class="absolute inset-x-0 bottom-10 flex justify-center">
                <svg class="w-6 h-6 text-slate-300 rotate-180" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m0 0l-4-4m4 4l4-4"/>
                </svg>
              </div>
            </div>

            <p class="mt-4 text-xs text-slate-500">
              You always land on datasets. Studies only appear inside dataset detail popups; the rest of
              the interface is dimmed to keep the user in a clean, focused flow.
            </p>
          </div>
        </div>
      </section>

      <!-- DATASETS TAB -->
      <section id="tab-datasets" class="tab-content">
        <div class="grid lg:grid-cols-[260px,1fr] gap-6">

          <!-- Filters (client side) -->
          <aside class="bg-white border border-slate-200 rounded-2xl p-4 h-fit">
            <h2 class="text-sm font-semibold text-slate-900 mb-3">Filter datasets (prototype)</h2>

            <div class="mb-4">
              <div class="text-xs font-semibold text-slate-500 mb-1.5">Disorder / construct</div>
              <input id="filter-construct"
                     type="text"
                     placeholder="Depressive Disorder, Emotional & Behavioural, PTSD…"
                     class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-xs focus:outline-none focus:ring-2 focus:ring-brand-400 focus:border-brand-400">
            </div>

            <div class="mb-4">
              <div class="text-xs font-semibold text-slate-500 mb-1.5">Access type</div>
              <select id="filter-access"
                      class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-xs bg-white focus:outline-none focus:ring-2 focus:ring-brand-400 focus:border-brand-400">
                <option value="">Any</option>
                <option value="Open">Open</option>
                <option value="Restricted">Restricted</option>
                <option value="Formal Request">Formal Request</option>
              </select>
            </div>

            <p class="text-[11px] text-slate-500">
              Global search (top bar) searches <span class="font-semibold">all</span> fields:
              dataset, source, description, constructs, instruments, studies, URLs, and emails.
            </p>
          </aside>

          <!-- Dataset list -->
          <div class="space-y-5">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-sm font-semibold text-slate-900">Datasets (from your test Excel)</h2>
                <p class="text-xs text-slate-500">
                  Click a dataset card to open a popup with details and studies. Other content is dimmed.
                </p>
              </div>
              <div class="text-xs text-slate-500">
                <span id="dataset-count">0</span> datasets
              </div>
            </div>

            <div id="dataset-list" class="grid md:grid-cols-2 gap-4">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- CONSTRUCTS TAB -->
      <section id="tab-constructs" class="tab-content">
        <div class="grid lg:grid-cols-[260px,1fr] gap-6">
          <aside class="bg-white border border-slate-200 rounded-2xl p-4 h-fit">
            <h2 class="text-sm font-semibold text-slate-900 mb-3">Constructs</h2>
            <div class="mb-4">
              <div class="text-xs font-semibold text-slate-500 mb-1.5">Search constructs</div>
              <input id="construct-search"
                     type="text"
                     placeholder="Depressive Disorder, Emotional & Behavioural, PTSD…"
                     class="w-full px-3 py-1.5 rounded-lg border border-slate-200 text-xs focus:outline-none focus:ring-2 focus:ring-brand-400 focus:border-brand-400">
            </div>
            <p class="text-[11px] text-slate-500">
              Constructs are taken from the <code>Constructs</code> column in your test data. Click a
              construct to jump to the Datasets tab with that filter applied.
            </p>
          </aside>

          <div class="space-y-4">
            <div>
              <h2 class="text-sm font-semibold text-slate-900">Constructs derived from test data</h2>
              <p class="text-xs text-slate-500">
                Click a construct to view datasets that capture it.
              </p>
            </div>

            <div id="construct-list" class="flex flex-wrap gap-2 text-[11px]">
              <!-- Filled by JS -->
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-200 bg-white mt-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap justify-between items-center gap-2">
      <p class="text-[11px] text-slate-500">
        Mental Health Data Discovery · Test data prototype
      </p>
      <p class="text-[11px] text-slate-400">
        Datasets as first-class · Studies only under datasets
      </p>
    </div>
  </footer>
</div>

<!-- DATASET MODAL (details popup) -->
<div id="dataset-modal" class="fixed inset-0 bg-slate-900/40 z-40 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full relative p-4 sm:p-5">
      <button id="dataset-modal-close"
              class="absolute top-2 right-2 inline-flex items-center justify-center w-7 h-7 rounded-full border border-slate-200 text-slate-500 hover:bg-slate-100">
        <span class="sr-only">Close</span>
        ×
      </button>
      <div id="dataset-modal-body" class="space-y-3 text-[11px] sm:text-xs text-slate-700 break-long">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
</div>

<!-- DATA & LOGIC -->
<script>
  // === Test data from your Excel (Dataset rows only) ===
  const DATASETS = [
    {
      "Dataset": "National Income Dynamics Study (NIDS), wave 4",
      "Source": "DataFirst",
      "Access Type": "Open",
      "Desciption": "The National Income Dynamics Study (NIDS) is ... of the well-being of South Africans, to be tracked over time.",
      "Constructs": "Depressive Disorder",
      "Instrument": "CES-D 10",
      "Studies": "Ajaero, C.K., C.T. Nzeadibe, and E.E. Igboeli, Rural–urban differences in depressive symptoms among South African adults using NIDS Wave 4 data. South African Journal of Child Health, 2018. 12: p. s71–s74.",
      "Access/Dowmload": "https://url.za.m.mimecastprotect.com/s/HsX0C2RqnrcZq396FnfVC5Rqaw",
      "Request": null
    },
    {
      "Dataset": "Agincourt HDSS",
      "Source": "Agincourt",
      "Access Type": "Restricted",
      "Desciption": "The Agincourt website (https://url.za.m.mimecastprotect.com/s/Y672C3lrovu91KExCqh8CQd6GI) facilitates published data access, with levels of data extraction and access dependent on appropriate ethical approvals.",
      "Constructs": "Emotional and Behavioural difficulties",
      "Instrument": "Strengths and Difficulties Questionnaire (SDQ) - Teacher-report scales",
      "Studies": "Cortina, M.A., et al., Childhood psychological problems in school settings in rural South Africa: Findings from the Agincourt HDSS. Social Psychiatry and Psychiatric Epidemiology, 2013. 48: p. 379–393.",
      "Access/Dowmload": "https://url.za.m.mimecastprotect.com/s/POC9C48vpwc9N5v6CBirC4kBvu",
      "Request": null
    },
    {
      "Dataset": "SHaW study",
      "Source": "Professor Stephen Stansfeld",
      "Access Type": "Formal Request",
      "Desciption": "The SHaW study examines mental health outcomes among South African adolescents with detailed information on school environments and social determinants.",
      "Constructs": "Depressive Disorder",
      "Instrument": "Revised Child Anxiety and Depression Scale (RCADS)",
      "Studies": "Das-Munshi J, Lund C, Mathews C, Clark C, Rothon C, Nthethe N, et al. (2023). Gender-specific pathways to depression among South African adolescents: Longitudinal findings from the SHaW study.",
      "Access/Dowmload": null,
      "Request": "s.a.stansfeld@qmul.ac.uk"
    },
    {
      "Dataset": "Hiscox et al [Dataset]",
      "Source": "Lucy V. Hiscox",
      "Access Type": "Formal Request",
      "Desciption": "Dataset associated with Hiscox et al. study on sex differences in post-traumatic stress disorder among South African youth.",
      "Constructs": "PTSD",
      "Instrument": "Child PTSD Symptom Scale - Self Report for DSM-5 (CPSS-SR-5)",
      "Studies": "Hiscox, L.V., et al., Sex differences in post-traumatic stress disorder among South African adolescents: Evidence from school-based surveys. European Journal of Psychotraumatology, 2021. 12(1): 1978669.",
      "Access/Dowmload": null,
      "Request": "lh2235@bath.ac.uk"
    },
    {
      "Dataset": "Center for Public Mental Health (CPMH) Data",
      "Source": "Mirriam Mkhize",
      "Access Type": "Formal Request",
      "Desciption": "This study recruited a total of 621 participants aged 13–18 years from rural and semi-urban communities in the Western Cape Province.",
      "Constructs": "Depressive Disorder",
      "Instrument": "PHQ-A",
      "Studies": "Mkhize, M., van der Westhuizen, C., & Sorsdahl, K. (2024). Depression among South African adolescents in low-resource communities. Comprehensive Psychiatry, 131, 152469. https://url.za.m.mimecastprotect.com/s/cNjEC58wqxcpm9DRF2slCkAZub",
      "Access/Dowmload": null,
      "Request": "mkhmir003@myuct.ac.za"
    }
  ];

  // === Tab handling ===
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  function activateTab(targetId) {
    contents.forEach(c => c.classList.remove('active'));
    const el = document.getElementById(targetId);
    if (el) el.classList.add('active');
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      if (!target) return;
      activateTab(target);
    });
  });

  // === Helpers ===
  function parseStudies(text) {
    if (!text) return [];
    const trimmed = text.trim();
    if (!trimmed) return [];
    // Extend later if you add delimiters
    return [trimmed];
  }

  function accessBadge(dataset) {
    const type = dataset["Access Type"] || "";
    if (type === "Open") {
      return '<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-[11px] font-medium border border-emerald-100">Open</span>';
    } else if (type === "Restricted") {
      return '<span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 text-[11px] font-medium border border-amber-100">Restricted</span>';
    } else if (type === "Formal Request") {
      return '<span class="px-2 py-0.5 rounded-full bg-sky-50 text-sky-700 text-[11px] font-medium border border-sky-100">Formal Request</span>';
    } else {
      return '<span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 text-[11px] font-medium border border-slate-200">Unknown</span>';
    }
  }

  function buildAccessAction(dataset) {
    const type = dataset["Access Type"] || '';
    const hasUrl = !!dataset["Access/Dowmload"];
    const hasEmail = !!dataset.Request;

    if (type === 'Open' && hasUrl) {
      return `
        <a href="${dataset["Access/Dowmload"]}" target="_blank" rel="noopener"
           class="inline-flex items-center px-3 py-1.5 rounded-full bg-emerald-600 text-white text-[11px] font-semibold hover:bg-emerald-700">
          Open data portal
        </a>
      `;
    } else if (type === 'Restricted' && hasUrl) {
      return `
        <a href="${dataset["Access/Dowmload"]}" target="_blank" rel="noopener"
           class="inline-flex items-center px-3 py-1.5 rounded-full bg-amber-500 text-white text-[11px] font-semibold hover:bg-amber-600">
          Visit access portal
        </a>
      `;
    } else if (type === 'Formal Request' && hasEmail) {
      const subject = encodeURIComponent(`Data access request: ${dataset.Dataset || ''}`);
      const body = encodeURIComponent(
        `Dear ${dataset.Source || ''},\n\nI would like to request access to the dataset "${dataset.Dataset || ''}" for mental health research.\n\nBest regards,\n`
      );
      return `
        <a href="mailto:${dataset.Request}?subject=${subject}&body=${body}"
           class="inline-flex items-center px-3 py-1.5 rounded-full bg-sky-600 text-white text-[11px] font-semibold hover:bg-sky-700">
          Email data custodian
        </a>
      `;
    } else if (hasEmail) {
      const subject = encodeURIComponent(`Enquiry: ${dataset.Dataset || ''}`);
      return `
        <a href="mailto:${dataset.Request}?subject=${subject}"
           class="inline-flex items-center px-3 py-1.5 rounded-full bg-slate-700 text-white text-[11px] font-semibold hover:bg-slate-800">
          Email contact
        </a>
      `;
    } else {
      return `
        <span class="text-[11px] text-slate-500">
          No direct access URL or email specified in test data.
        </span>
      `;
    }
  }

  // === Dataset list ===
  let filteredDatasets = [...DATASETS];
  const datasetListEl   = document.getElementById('dataset-list');
  const datasetCountEl  = document.getElementById('dataset-count');

  function renderDatasetList() {
    datasetListEl.innerHTML = '';
    datasetCountEl.textContent = filteredDatasets.length.toString();

    filteredDatasets.forEach((d) => {
      const constructs = (d.Constructs || '').split(',').map(s => s.trim()).filter(Boolean);
      const studiesArr = parseStudies(d.Studies);
      const studyCount = studiesArr.length;
      const studyLabel = studyCount === 1 ? 'study' : 'studies';

      const card = document.createElement('article');
      card.className =
        'bg-white rounded-2xl border border-slate-200 p-4 flex flex-col gap-2 cursor-pointer hover:border-brand-300 hover:shadow-sm';

      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <div>
            <h3 class="text-sm font-semibold text-slate-900">
              ${d.Dataset || 'Untitled dataset'}
            </h3>
            <p class="text-xs text-slate-500">
              ${d.Source || 'Source unknown'}
            </p>
          </div>
          ${accessBadge(d)}
        </div>
        <p class="text-xs text-slate-600 line-clamp-3">
          ${(d.Desciption || '').replace(/\s+/g,' ').trim()}
        </p>
        <div class="flex flex-wrap gap-1.5 mt-1 text-[10px] text-slate-600">
          ${constructs.map(c => `<span class="px-2 py-0.5 rounded-full bg-slate-100">${c}</span>`).join('')}
          ${d.Instrument ? `<span class="px-2 py-0.5 rounded-full bg-slate-100">${d.Instrument}</span>` : ''}
        </div>
        <div class="flex items-center justify-between mt-2 text-[11px] text-slate-500">
          <span>${studyCount > 0 ? `${studyCount} ${studyLabel} in test data` : 'No studies linked in test data'}</span>
          <span class="text-brand-700 font-semibold hover:text-brand-800 text-[11px]">
            View details →
          </span>
        </div>
      `;

      card.addEventListener('click', () => {
        openDatasetModal(d);
      });

      datasetListEl.appendChild(card);
    });
  }

  // === Dataset modal ===
  const datasetModalEl      = document.getElementById('dataset-modal');
  const datasetModalBodyEl  = document.getElementById('dataset-modal-body');
  const datasetModalCloseEl = document.getElementById('dataset-modal-close');

  function openDatasetModal(dataset) {
    const constructs = (dataset.Constructs || '').split(',').map(s => s.trim()).filter(Boolean);
    const studiesArr = parseStudies(dataset.Studies);
    const studyCount = studiesArr.length;
    const studyLabel = studyCount === 1 ? 'study' : 'studies';

    datasetModalBodyEl.innerHTML = `
      <div class="flex flex-wrap items-start justify-between gap-3 mb-1">
        <div>
          <h3 class="text-sm font-semibold text-slate-900 mb-0.5">
            ${dataset.Dataset || 'Untitled dataset'}
          </h3>
          <p class="text-xs text-slate-500">
            ${dataset.Source || 'Source unknown'} · ${studyCount} ${studyLabel} in test data
          </p>
        </div>
        <div class="flex flex-wrap gap-2 text-[11px] items-center">
          ${accessBadge(dataset)}
          ${buildAccessAction(dataset)}
        </div>
      </div>

      <p class="text-xs text-slate-600 mb-3">
        ${(dataset.Desciption || '').replace(/\s+/g,' ').trim()}
      </p>

      <div class="grid md:grid-cols-[1.2fr,1fr] gap-4 mt-1">
        <div>
          <h4 class="text-xs font-semibold text-slate-700 mb-1.5">
            Mental health constructs & instruments
          </h4>
          <div class="flex flex-wrap gap-1.5 text-[11px] text-slate-700 mb-2">
            ${constructs.map(c => `<span class="px-2 py-0.5 rounded-full bg-slate-100">${c}</span>`).join('')}
            ${dataset.Instrument ? `<span class="px-2 py-0.5 rounded-full bg-slate-100">${dataset.Instrument}</span>` : ''}
          </div>
          <p class="text-[11px] text-slate-500">
            Constructs and instruments are taken directly from your <code>Constructs</code> and <code>Instrument</code> columns.
          </p>
        </div>

        <div>
          <h4 class="text-xs font-semibold text-slate-700 mb-1.5">
            Studies using this dataset
          </h4>
          ${
            studiesArr.length > 0
              ? `
                <div class="space-y-2 max-h-52 overflow-auto pr-1">
                  ${studiesArr.map((s, idx) => `
                    <article class="border border-slate-200 rounded-xl p-2.5 text-[11px] text-slate-700 bg-slate-50/60">
                      <div class="font-semibold text-slate-800 mb-0.5">
                        Study ${idx + 1}
                      </div>
                      <div>
                        ${s}
                      </div>
                    </article>
                  `).join('')}
                </div>
              `
              : `<p class="text-[11px] text-slate-500">No study text provided for this dataset in the test file.</p>`
          }
          <p class="mt-2 text-[11px] text-slate-500">
            In a full build, each study would be its own entity with metadata, but still surfaced inside this dataset popup.
          </p>
        </div>
      </div>
    `;

    datasetModalEl.classList.remove('hidden');
  }

  function closeDatasetModal() {
    datasetModalEl.classList.add('hidden');
    datasetModalBodyEl.innerHTML = '';
  }

  datasetModalCloseEl.addEventListener('click', closeDatasetModal);
  datasetModalEl.addEventListener('click', (e) => {
    if (e.target === datasetModalEl) {
      closeDatasetModal();
    }
  });

  // === Filtering logic (search all fields) ===
  const filterConstructInput = document.getElementById('filter-construct');
  const filterAccessSelect   = document.getElementById('filter-access');
  const globalSearchInput    = document.getElementById('global-search');

  function applyFilters() {
    const constructFilter = (filterConstructInput.value || '').toLowerCase();
    const accessFilter    = filterAccessSelect.value;
    const globalFilter    = (globalSearchInput.value || '').toLowerCase();

    filteredDatasets = DATASETS.filter(d => {
      const constructs = (d.Constructs || '').toLowerCase();

      if (accessFilter && d["Access Type"] !== accessFilter) return false;
      if (constructFilter && !constructs.includes(constructFilter)) return false;

      if (globalFilter) {
        const allText = [
          d.Dataset,
          d.Source,
          d["Access Type"],
          d.Desciption,
          d.Constructs,
          d.Instrument,
          d.Studies,
          d["Access/Dowmload"],
          d.Request
        ].map(x => (x || '').toString().toLowerCase()).join(' ');

        if (!allText.includes(globalFilter)) return false;
      }

      return true;
    });

    renderDatasetList();
  }

  filterConstructInput.addEventListener('input', applyFilters);
  filterAccessSelect.addEventListener('change', applyFilters);
  globalSearchInput.addEventListener('input', applyFilters);

  // === Constructs tab ===
  const constructListEl   = document.getElementById('construct-list');
  const constructSearchEl = document.getElementById('construct-search');

  function getUniqueConstructs() {
    const set = new Set();
    DATASETS.forEach(d => {
      (d.Constructs || '').split(',').forEach(c => {
        const trimmed = c.trim();
        if (trimmed) set.add(trimmed);
      });
    });
    return Array.from(set);
  }

  let allConstructs = getUniqueConstructs();
  let shownConstructs = [...allConstructs];

  function renderConstructList() {
    constructListEl.innerHTML = '';
    shownConstructs.forEach(c => {
      const btn = document.createElement('button');
      btn.className =
        'px-3 py-1 rounded-full bg-slate-100 text-slate-800 hover:bg-brand-50 hover:text-brand-800 border border-slate-200';
      btn.textContent = c;
      btn.addEventListener('click', () => {
        filterConstructInput.value = c;
        activateTab('tab-datasets');
        applyFilters();
      });
      constructListEl.appendChild(btn);
    });

    if (shownConstructs.length === 0) {
      constructListEl.innerHTML =
        '<p class="text-[11px] text-slate-500">No constructs match this search in the test data.</p>';
    }
  }

  constructSearchEl.addEventListener('input', () => {
    const q = (constructSearchEl.value || '').toLowerCase();
    shownConstructs = allConstructs.filter(c => c.toLowerCase().includes(q));
    renderConstructList();
  });

  // === Initial render ===
  document.addEventListener('DOMContentLoaded', () => {
    applyFilters();
    allConstructs = getUniqueConstructs();
    shownConstructs = [...allConstructs];
    renderConstructList();
  });
</script>

</body>
</html>
